name: Deploy Backend to Azure Function App

on:
  push:
    branches:
      - main
    paths:
      - 'azure-backend-deploy-ready.js'
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: cutover-mgmt-api
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './backend'
  NODE_VERSION: '24.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: 'Setup Node.js ${{ env.NODE_VERSION }}'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: 'Install Dependencies'
      shell: bash
      run: |
        cd "${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}"
        npm install --production

    - name: 'Create deployment package'
      shell: bash
      run: |
        cd "${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}"
        zip -r ../backend-deploy.zip . -x "*.git/*"

    - name: 'Deploy via Kudu API'
      shell: bash
      run: |
        # Extract credentials from publish profile
        PUBLISH_PROFILE='${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}'
        USERNAME=$(echo "$PUBLISH_PROFILE" | sed -n 's/.*userName="\([^"]*\)".*/\1/p' | head -1)
        PASSWORD=$(echo "$PUBLISH_PROFILE" | sed -n 's/.*userPWD="\([^"]*\)".*/\1/p' | head -1)

        # Deploy using Kudu zip deploy API (bypasses validation)
        curl -X POST \
          -u "$USERNAME:$PASSWORD" \
          -H "Content-Type: application/zip" \
          --data-binary @backend-deploy.zip \
          --fail \
          --max-time 300 \
          "https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/zipdeploy?isAsync=false"

        echo "Deployment completed successfully"
