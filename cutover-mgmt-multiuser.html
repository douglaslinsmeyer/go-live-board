<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cutover Management App - PING Project Evo</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f1f5f9;min-height:100vh}
#root{height:100vh}
select,input{outline:none}
select:focus,input:focus{border-color:#3b82f6!important}
textarea{font-family:inherit;outline:none}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#f1f5f9}
::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useMemo,useCallback,useEffect,useRef}=React;

// ============================================================
// CONFIG ‚Äî set API_BASE to your Azure Function App URL
// Leave empty to run in localStorage-only mode
// ============================================================
const API_BASE = ""; // e.g. "https://cutover-mgmt-api.azurewebsites.net/api"
const USE_API = !!API_BASE;
// ============================================================

const PH=[
  {id:"Phase 0",l:"BL",f:"Env Baseline / Cutover Readiness",dt:"Feb 2-16",cl:"#6366f1"},
  {id:"Phase 00",l:"P0",f:"Migrate Customers to PRD",dt:"Feb 16-17",cl:"#8b5cf6"},
  {id:"Phase 1",l:"P1",f:"Master Data Loading",dt:"Feb 16-22",cl:"#3b82f6"},
  {id:"Phase 2",l:"P2",f:"Master Data Sync",dt:"Feb 16-22",cl:"#0ea5e9"},
  {id:"Phase 3",l:"P3",f:"Trans Data Prep",dt:"Feb 23-25",cl:"#14b8a6"},
  {id:"Phase 4",l:"P4",f:"Blackout / Trans Data Migration",dt:"Feb 25-Mar 1",cl:"#f59e0b"},
  {id:"Phase 5",l:"P5",f:"Hypercare",dt:"Mar 2-9",cl:"#10b981"},
];
const STATUSES=[
  {id:"0-Not Mock",l:"Not Mock",c:"#94a3b8",bg:"#f1f5f9",s:"NM"},
  {id:"1-Planned",l:"Planned",c:"#3b82f6",bg:"#eff6ff",s:"PLN"},
  {id:"2-WIP",l:"In Progress",c:"#f59e0b",bg:"#fffbeb",s:"WIP"},
  {id:"3-Blocked",l:"Blocked",c:"#dc2626",bg:"#fef2f2",s:"BLK"},
  {id:"4-Complete",l:"Complete",c:"#10b981",bg:"#ecfdf5",s:"DONE"},
  {id:"6-Archive",l:"Archived",c:"#94a3b8",bg:"#f9fafb",s:"ARC"},
];
const SM={};STATUSES.forEach(s=>{SM[s.id]=s;});
const TZ_L=[{id:"GMT",l:"UK (GMT)"},{id:"AZT",l:"AZ (UTC-7)"},{id:"EST",l:"US East"},{id:"BOTH",l:"AZ+UK"},{id:"UTC",l:"UTC"}];
const TS_M=[{id:"both",l:"Est+Act"},{id:"est",l:"Est"},{id:"act",l:"Act"}];
const VM=[{id:"phase",l:"Phase"},{id:"day",l:"Day"},{id:"flat",l:"Flat"}];
const ADMIN_NAMES=["Brad Amundson","Lewis Rogal"];
const ADMIN_PASS="PingEvo2026";
const fieldLabels={d:"Description",w:"Workstream",a:"Application",p:"Phase",r:"Responsible",ps:"PING SME",ex:"Executor",pp:"PING Support",is:"Infor SME",sd:"Start Date",ed:"End Date",ui:"US/CA Impact",mo:"Mock Only",jp:"JP Execute",blocker:"Blocker",estStart:"Est Start",estEnd:"Est End",actStart:"Act Start",actEnd:"Act End"};

// ============================================================
// STORAGE ABSTRACTION
// ============================================================
let authToken="";
function setAuthToken(name,role,pass){authToken=`${name}::${role}::${pass||""}`;}

const store={
  async getTasks(){
    if(USE_API){try{const r=await fetch(`${API_BASE}/tasks`);if(!r.ok)return null;const d=await r.json();return d.tasks;}catch(e){console.error("API getTasks failed",e);return null;}}
    try{const v=localStorage.getItem("cma-tasks");return v?JSON.parse(v):null;}catch(e){return null;}
  },
  async saveTasks(tasks){
    if(USE_API){try{await fetch(`${API_BASE}/tasks`,{method:"PUT",headers:{"Content-Type":"application/json","Authorization":`Bearer ${authToken}`},body:JSON.stringify({tasks})});}catch(e){console.error("API saveTasks failed",e);}return;}
    try{localStorage.setItem("cma-tasks",JSON.stringify(tasks));}catch(e){}
  },
  async patchTask(id,updates){
    if(USE_API){try{await fetch(`${API_BASE}/tasks/${encodeURIComponent(id)}`,{method:"PATCH",headers:{"Content-Type":"application/json","Authorization":`Bearer ${authToken}`},body:JSON.stringify(updates)});}catch(e){console.error("API patchTask failed",e);}return;}
  },
  async getLog(){
    if(USE_API){try{const r=await fetch(`${API_BASE}/log`);if(!r.ok)return[];const d=await r.json();return d.log||[];}catch(e){return[];}}
    try{const v=localStorage.getItem("cma-log");return v?JSON.parse(v):[];}catch(e){return[];}
  },
  async addLogEntry(entry){
    if(USE_API){try{await fetch(`${API_BASE}/log`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(entry)});}catch(e){}}
  },
  async saveLog(log){
    if(!USE_API){try{localStorage.setItem("cma-log",JSON.stringify(log));}catch(e){}}
  },
  async getPresets(){
    try{const v=localStorage.getItem("cma-presets");return v?JSON.parse(v):[];}catch(e){return[];}
  },
  async savePresets(p){try{localStorage.setItem("cma-presets",JSON.stringify(p));}catch(e){}},
};

// ============================================================
// HELPERS
// ============================================================
function pPh(r){
  if(!r)return"";const s=r.trim();
  if(s.includes("Phase 0 ")||s.includes("Phase 0-")||s.includes("Baseline")||s.includes("Cutover Readiness"))return"Phase 0";
  if(s.includes("Phase 00")||s.includes("Migrate Customers"))return"Phase 00";
  for(const p of PH)if(s.includes(p.id))return p.id;
  return s;
}
function gSt(r){
  if(!r)return"1-Planned";const s=r.trim();
  if(s.startsWith("0"))return"0-Not Mock";if(s.startsWith("1"))return"1-Planned";
  if(s.startsWith("2"))return"2-WIP";if(s.startsWith("3"))return"3-Blocked";
  if(s.startsWith("4"))return"4-Complete";if(s.startsWith("6"))return"6-Archive";
  return"1-Planned";
}
function pD(s){
  if(!s)return null;
  const clean=(s+"").replace(/[()]/g,"").trim();
  const m=clean.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
  if(m){let y=parseInt(m[3]);if(y<100)y+=2000;const d=new Date(y,parseInt(m[1])-1,parseInt(m[2]));return isNaN(d)?null:d;}
  const iso=clean.match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
  if(iso){const d=new Date(parseInt(iso[1]),parseInt(iso[2])-1,parseInt(iso[3]));return isNaN(d)?null:d;}
  return null;
}
function now(){return new Date().toISOString();}
function fDS(d){if(!d)return"‚Äî";return(d.getMonth()+1)+"/"+d.getDate()+"/"+(d.getFullYear()%100<10?"0"+(d.getFullYear()%100):d.getFullYear()%100);}
function fTS(iso,tz){
  if(!iso)return"‚Äî";
  try{
    const d=new Date(iso);
    if(tz==="AZT"){const az=new Date(d.getTime()-7*3600000);return az.toLocaleDateString("en-US",{month:"numeric",day:"numeric"})+" "+az.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:true})+" AZ";}
    return d.toLocaleString("en-US",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});
  }catch{return iso.slice(0,16);}
}
function isDone(t){return t.s==="4-Complete"||t.s==="0-Not Mock"||t.s==="6-Archive";}

// ============================================================
// APP
// ============================================================
function App(){
  const[tasks,sT]=useState([]);
  const[loaded,sL]=useState(false);
  const[err,sE]=useState("");
  const[tz,sTz]=useState("AZT");
  const[tsM,sTsM]=useState("both");
  const[vM,sVM]=useState("phase");
  const[pF,sPF]=useState("all");
  const[wF,sWF]=useState("All");
  const[sF,sSF]=useState("all");
  const[rF,sRF]=useState("All");
  const[search,sSrch]=useState("");
  const[hideD,sHD]=useState(false);
  const[stFlt,sStFlt]=useState(null);
  const[focD,sFocD]=useState("");
  const[dM,sDM]=useState("none");
  const[goalId,sGI]=useState("");
  const[showHelp,sSH]=useState(false);
  const[panel,sPanel]=useState(null);
  const[actLog,sAL]=useState([]);
  const[uName,sUN]=useState("");
  const[uRole,sUR]=useState("user");
  const[saving,sSav]=useState(false);
  const[showLog,sSLog]=useState(false);
  const[presets,sPre]=useState([]);
  const[showPre,sSPre]=useState(false);
  const[preNm,sPreNm]=useState("");
  const[nameIn,sNI]=useState("");
  const[adminPIn,sAPI]=useState("");
  const[showAP,sSAP]=useState(false);
  const[passErr,sPE]=useState(false);
  const[addM,sAM]=useState(false);
  const[nT,sNT]=useState({id:"",s:"1-Planned",w:"",a:"All",p:"Phase 1",c:"",d:"",r:"PING",ps:"",ex:"",pp:"",is:"",sd:"",ed:""});
  const[lastSync,sLS]=useState(null);
  const isAdmin=uRole==="admin";
  const autoRefRef=useRef(null);

  // Load on mount
  useEffect(()=>{
    async function loadAll(){
      const t=await store.getTasks();
      if(t?.length){t.forEach(x=>{x.sdD=pD(x.sd);x.edD=pD(x.ed);if(!x.notes)x.notes=[];if(!x.deps)x.deps=[];if(!x.history)x.history=[];});sT(t);sL(true);}
      const l=await store.getLog();if(l?.length)sAL(l);
      const p=await store.getPresets();if(p?.length)sPre(p);
      sLS(new Date());
    }
    loadAll();
  },[]);

  // Auto-refresh every 30s in API mode
  useEffect(()=>{
    if(!USE_API||!loaded)return;
    autoRefRef.current=setInterval(async()=>{
      const t=await store.getTasks();
      if(t?.length){t.forEach(x=>{x.sdD=pD(x.sd);x.edD=pD(x.ed);if(!x.notes)x.notes=[];if(!x.deps)x.deps=[];if(!x.history)x.history=[];});sT(t);}
      const l=await store.getLog();if(l?.length)sAL(l);
      sLS(new Date());
    },30000);
    return()=>clearInterval(autoRefRef.current);
  },[loaded]);

  async function saveAll(t,log){
    sSav(true);
    const ser=t.map(({sdD,edD,...r})=>r);
    await store.saveTasks(ser);
    if(!USE_API&&log)await store.saveLog(log);
    sSav(false);
  }

  function addL(msg){
    const e={id:Date.now(),ts:now(),user:uName||"System",msg};
    const u=[e,...actLog].slice(0,500);
    sAL(u);
    store.addLogEntry(e);
    if(!USE_API)store.saveLog(u);
    return u;
  }

  function parseCSV(txt){
    try{
      const result=Papa.parse(txt,{header:true,skipEmptyLines:true,dynamicTyping:false,delimitersToGuess:[",","\t","|",";"]});
      if(!result.data?.length){sE("No data found.");return;}
      const h=Object.keys(result.data[0]).map(x=>x.trim());
      const f=ps=>h.find(x=>{const l=x.toLowerCase().replace(/[^a-z0-9]/g,"");return ps.some(p=>l.includes(p));})||"";
      const hI=f(["activity"])||h[0],hS=f(["status"]),hW=f(["workstream"]),hA=f(["application"]),
            hP=f(["phase","group"]),hC=f(["taskclassification","classification"]),
            hD=f(["descriptionandnotes","description"]),hU=f(["usca","usimpact","impact"]),
            hSD=f(["expectedstart","startdate"]),hED=f(["expectedend","enddate"]),
            hR=f(["responsible","pinginfor"]),hPS=f(["pingsme"]),hEX=f(["executor"]),
            hPP=f(["pingsupport"]),hIS=f(["inforsme"]),hMO=f(["mockonly","mock"]),
            hJP=f(["japantoexecute","japan"]),hN=f(["commentsandnotes","comment"]);
      const parsed=result.data.map(r=>{
        const id=(r[hI]||"").trim();if(!id)return null;
        return{id,s:gSt(r[hS]),w:(r[hW]||"").trim()||"Other",a:(r[hA]||"").trim()||"All",
               p:pPh(r[hP]),c:(r[hC]||"").trim(),d:(r[hD]||"").trim(),r:(r[hR]||"").trim(),
               ps:(r[hPS]||"").trim(),ex:(r[hEX]||"").trim(),pp:(r[hPP]||"").trim(),is:(r[hIS]||"").trim(),
               sd:(r[hSD]||"").trim(),ed:(r[hED]||"").trim(),sdD:pD(r[hSD]),edD:pD(r[hED]),
               ui:!!(r[hU]||"").trim(),mo:(r[hMO]||"").toString().toLowerCase().includes("yes"),
               jp:(r[hJP]||"").toString().toLowerCase().includes("yes"),n:(r[hN]||"").trim(),
               estStart:"",estEnd:"",actStart:"",actEnd:"",blocker:"",notes:[],deps:[],history:[],
               updatedBy:"",updatedAt:""};
      }).filter(Boolean);
      const log=addL("Uploaded CSV: "+parsed.length+" tasks");
      sT(parsed);sL(true);sE("");sSH(false);saveAll(parsed,log);
    }catch(e){sE("Parse error: "+e.message);}
  }
  function handleFile(e){const fi=e.target.files[0];if(!fi)return;const rd=new FileReader();rd.onload=ev=>parseCSV(ev.target.result);rd.readAsText(fi);}

  function exportCSV(){
    if(!tasks.length)return;
    const cols=["Activity","Status","Workstream","Application","Phase/Group","Task Classification","Description and Notes","US/CA IMPACT INDICATOR","Mock ONLY Activity?","JAPAN to Execute","Expected start date","Expected end date","Responsible (PING / INFOR)","PING SME","Executor","PING Support","Infor SME","Comments and Notes","Dependencies","Blocker","App Notes","Est Start","Est End","Act Start","Act End","Updated By","Updated At"];
    const rows=tasks.map(t=>[t.id,t.s,t.w,t.a,t.p,t.c,t.d,t.ui?"YES":"",t.mo?"YES":"",t.jp?"YES":"",t.sd,t.ed,t.r,t.ps,t.ex,t.pp,t.is,t.n,(t.deps||[]).join("|"),t.blocker||"",(t.notes||[]).map(n=>n.user+": "+n.text).join(" | "),t.estStart,t.estEnd,t.actStart,t.actEnd,t.updatedBy,t.updatedAt]);
    const csv=[cols,...rows].map(r=>r.map(v=>`"${(v||"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="cutover-plan-export.csv";a.click();URL.revokeObjectURL(url);
  }

  function updField(id,field,val){
    sT(prev=>{
      const task=prev.find(t=>t.id===id);const oldVal=task?task[field]:"";
      const next=prev.map(t=>{if(t.id!==id)return t;const u={...t,[field]:val,updatedBy:uName||"?",updatedAt:now()};if(field==="sd")u.sdD=pD(val);if(field==="ed")u.edD=pD(val);return u;});
      const lbl=fieldLabels[field]||field;
      const msg=typeof val==="boolean"?`${id}: ${lbl} ${val?"on":"off"}`:`${id}: ${lbl} ‚Üí "${(val||"").toString().slice(0,25)}"`;
      const log=addL(msg);
      if(USE_API){const t2=next.find(t=>t.id===id);if(t2){const{sdD,edD,...patch}=t2;store.patchTask(id,{[field]:val,updatedBy:uName||"?",updatedAt:now()});}}
      else saveAll(next,log);
      return next;
    });
  }
  function updStatus(id,ns){
    sT(prev=>{
      const task=prev.find(t=>t.id===id);const from=task?SM[task.s]?.l||task.s:"?";
      const next=prev.map(t=>{if(t.id!==id)return t;const hist=[{ts:now(),user:uName||"?",from:t.s,to:ns},...(t.history||[])].slice(0,50);return{...t,s:ns,updatedBy:uName||"?",updatedAt:now(),blocker:ns!=="3-Blocked"?"":t.blocker,history:hist};});
      const log=addL(`${id}: ${from} ‚Üí ${SM[ns]?.l||ns}`);
      if(USE_API){const t2=next.find(t=>t.id===id);if(t2){const{sdD,edD,...patch}=t2;store.patchTask(id,patch);}}
      else saveAll(next,log);
      return next;
    });
  }
  function addNote(id,text){
    if(!text.trim())return;
    sT(prev=>{
      const next=prev.map(t=>{if(t.id!==id)return t;return{...t,notes:[{ts:now(),user:uName||"?",text:text.trim()},...(t.notes||[])],updatedBy:uName||"?",updatedAt:now()};});
      const log=addL(`Note on ${id}: "${text.trim().slice(0,40)}"`);
      if(USE_API){const t2=next.find(t=>t.id===id);if(t2){const{sdD,edD,...patch}=t2;store.patchTask(id,patch);}}
      else saveAll(next,log);
      return next;
    });
  }
  function delTask(id){sT(prev=>{const next=prev.filter(t=>t.id!==id);const log=addL(`Deleted ${id}`);saveAll(next,log);return next;});sPanel(null);}
  function addTask(nt){
    if(!nt.id.trim()||!nt.d.trim())return;
    const t={...nt,sdD:pD(nt.sd),edD:pD(nt.ed),estStart:"",estEnd:"",actStart:"",actEnd:"",blocker:"",notes:[],deps:[],history:[],updatedBy:uName||"?",updatedAt:now()};
    sT(prev=>{const next=[...prev,t];const log=addL(`Added ${t.id}`);saveAll(next,log);return next;});
    sAM(false);
  }
  function addDep(id,depId){
    if(!depId.trim())return;
    sT(prev=>{
      const next=prev.map(t=>{if(t.id!==id)return t;const ex=(t.deps||[]).map(d=>d.toUpperCase());if(ex.includes(depId.trim().toUpperCase()))return t;return{...t,deps:[...(t.deps||[]),depId.trim()],updatedBy:uName||"?",updatedAt:now()};});
      const log=addL(`${id}: dep ‚Üí ${depId.trim()}`);
      if(USE_API){const t2=next.find(t=>t.id===id);if(t2){const{sdD,edD,...patch}=t2;store.patchTask(id,patch);}}
      else saveAll(next,log);
      return next;
    });
  }
  function removeDep(id,depId){
    sT(prev=>{
      const next=prev.map(t=>{if(t.id!==id)return t;return{...t,deps:(t.deps||[]).filter(d=>d.toUpperCase()!==depId.toUpperCase()),updatedBy:uName||"?",updatedAt:now()};});
      const log=addL(`${id}: removed dep ${depId}`);
      if(USE_API){const t2=next.find(t=>t.id===id);if(t2){const{sdD,edD,...patch}=t2;store.patchTask(id,patch);}}
      else saveAll(next,log);
      return next;
    });
  }

  const isDepBlocked=useCallback(t=>{
    if(!t.deps?.length||isDone(t))return false;
    return t.deps.some(depId=>{const dep=tasks.find(x=>x.id.toUpperCase()===depId.toUpperCase());return!dep||!isDone(dep);});
  },[tasks]);

  function savePre(){if(!preNm.trim())return;const p={id:Date.now(),name:preNm.trim(),pF,wF,sF,rF,search,hideD,stFlt};const u=[...presets,p];sPre(u);store.savePresets(u);sPreNm("");}
  function loadPre(p){sPF(p.pF||"all");sWF(p.wF||"All");sSF(p.sF||"all");sRF(p.rF||"All");sSrch(p.search||"");sHD(p.hideD||false);sStFlt(p.stFlt||null);}
  function delPre(id){const u=presets.filter(p=>p.id!==id);sPre(u);store.savePresets(u);}

  const today=useMemo(()=>{const d=new Date();d.setHours(0,0,0,0);return d;},[]);
  const isPD=useCallback(t=>{if(isDone(t))return false;if(!t.edD)return false;const e=new Date(t.edD);e.setHours(23,59,59,999);return e<today;},[today]);
  const focObj=useMemo(()=>{if(!focD)return null;const d=new Date(focD+"T00:00:00");return isNaN(d)?null:d;},[focD]);
  const gIdx=useMemo(()=>goalId?tasks.findIndex(t=>t.id.toUpperCase()===goalId.trim().toUpperCase()):-1,[goalId,tasks]);
  const ws=useMemo(()=>{const s=new Set(tasks.map(t=>t.w));return["All",...Array.from(s).sort()];},[tasks]);
  const resps=useMemo(()=>{const s=new Set(tasks.map(t=>t.r).filter(Boolean));return["All",...Array.from(s).sort()];},[tasks]);

  const filtered=useMemo(()=>tasks.filter(t=>{
    if(pF!=="all"&&t.p!==pF)return false;
    if(wF!=="All"&&t.w!==wF)return false;
    if(sF!=="all"&&t.s!==sF)return false;
    if(rF!=="All"&&t.r!==rF)return false;
    if(hideD&&isDone(t))return false;
    if(search){const q=search.toLowerCase();if(![t.id,t.d,t.ps,t.ex,t.is,t.pp,t.n,t.w].some(v=>v&&v.toLowerCase().includes(q)))return false;}
    return true;
  }),[tasks,pF,wF,sF,rF,search,hideD]);

  const sf=useMemo(()=>{
    let l=filtered;
    if(stFlt)l=l.filter(t=>{
      if(stFlt==="done")return isDone(t);
      if(stFlt==="wip")return t.s==="2-WIP";
      if(stFlt==="pln")return t.s==="1-Planned";
      if(stFlt==="pastdue")return isPD(t);
      if(stFlt==="blocked")return t.s==="3-Blocked";
      if(stFlt==="depblk")return isDepBlocked(t);
      if(stFlt==="ui")return t.ui;
      return true;
    });
    if(focObj&&dM!=="none"&&dM!=="goal"){
      l=l.filter(t=>{
        if(isDone(t))return false;
        if(dM==="starting"){if(!t.sdD)return false;return t.sdD.getFullYear()===focObj.getFullYear()&&t.sdD.getMonth()===focObj.getMonth()&&t.sdD.getDate()===focObj.getDate();}
        if(dM==="dueby"){if(isPD(t))return true;if(!t.edD){if(!t.sdD)return false;return t.sdD<=focObj;}const ed=new Date(t.edD);ed.setHours(23,59,59,999);return ed<=new Date(focObj.getFullYear(),focObj.getMonth(),focObj.getDate(),23,59,59,999);}
        return true;
      });
    }
    if(goalId&&gIdx>=0&&dM==="goal")l=l.filter(t=>{if(isDone(t))return false;return tasks.findIndex(x=>x.id===t.id)<=gIdx;});
    return l;
  },[filtered,stFlt,isPD,isDepBlocked,focObj,dM,goalId,gIdx,tasks]);

  const stats=useMemo(()=>{
    const o={total:filtered.length,done:0,wip:0,pln:0,blocked:0,depblk:0,ui:0,pastdue:0};
    filtered.forEach(t=>{
      if(isDone(t))o.done++;
      else if(t.s==="2-WIP")o.wip++;
      else if(t.s==="1-Planned")o.pln++;
      else if(t.s==="3-Blocked")o.blocked++;
      if(t.ui)o.ui++;if(isPD(t))o.pastdue++;if(isDepBlocked(t))o.depblk++;
    });
    return o;
  },[filtered,isPD,isDepBlocked]);

  const phG=useMemo(()=>{
    const g={};PH.forEach(p=>{g[p.id]=[];});
    sf.forEach(t=>{if(g[t.p])g[t.p].push(t);else{if(!g.Other)g.Other=[];g.Other.push(t);}});
    return g;
  },[sf]);

  const dG=useMemo(()=>{
    const m=new Map();
    sf.forEach(t=>{const k=t.sdD?fDS(t.sdD):"No Date";if(!m.has(k))m.set(k,[]);m.get(k).push(t);});
    return Array.from(m.entries()).sort((a,b)=>{const da=pD(a[0]),db=pD(b[0]);if(!da&&!db)return 0;if(!da)return 1;if(!db)return-1;return da-db;});
  },[sf]);

  // ---- SIGN IN ----
  if(!uName){
    const known=["Brad Amundson","Lewis Rogal","Derek Harris","Tom Kabler","Darren Sullivan","Jeff Knode","Morgan Boushka","Kelly Von Hoene","Chakra Dhandapani"];
    return(
      <div style={{fontFamily:"-apple-system,BlinkMacSystemFont,sans-serif",maxWidth:480,margin:"60px auto",padding:"0 16px"}}>
        <div style={{background:"linear-gradient(135deg,#1e293b,#334155)",color:"#fff",padding:24,borderRadius:"12px 12px 0 0",textAlign:"center"}}>
          <div style={{fontSize:28,marginBottom:8}}>üìã</div>
          <h1 style={{margin:0,fontSize:20,fontWeight:700}}>Cutover Management App</h1>
          <p style={{margin:"4px 0 0",opacity:0.7,fontSize:12}}>PING Project Evo ‚Ä¢ UK/JP M3 Go-Live</p>
        </div>
        <div style={{background:"#fff",border:"1px solid #e2e8f0",borderTop:0,borderRadius:"0 0 12px 12px",padding:32}}>
          <label style={{display:"block",fontSize:12,fontWeight:600,color:"#64748b",marginBottom:4}}>Your Name</label>
          <input value={nameIn} onChange={e=>sNI(e.target.value)} list="ppl"
            onKeyDown={e=>{if(e.key==="Enter"&&nameIn.trim()){if(ADMIN_NAMES.some(n=>n.toLowerCase()===nameIn.trim().toLowerCase())){if(showAP){if(adminPIn===ADMIN_PASS){setAuthToken(nameIn.trim(),"admin",adminPIn);sUN(nameIn.trim());sUR("admin");sPE(false);}else sPE(true);}else sSAP(true);}else{setAuthToken(nameIn.trim(),"user","");sUN(nameIn.trim());sUR("user");}}}}
            placeholder="Type your full name‚Ä¶" style={{width:"100%",padding:"10px 12px",fontSize:14,border:"1px solid #d1d5db",borderRadius:8,boxSizing:"border-box",color:"#1e293b"}}/>
          <datalist id="ppl">{known.map(n=>(<option key={n} value={n}/>))}</datalist>
          {showAP&&(
            <div style={{marginTop:12}}>
              <label style={{display:"block",fontSize:12,fontWeight:600,color:"#64748b",marginBottom:4}}>Admin Password</label>
              <input type="password" value={adminPIn} onChange={e=>sAPI(e.target.value)}
                onKeyDown={e=>{if(e.key==="Enter"){if(adminPIn===ADMIN_PASS){setAuthToken(nameIn.trim(),"admin",adminPIn);sUN(nameIn.trim());sUR("admin");sPE(false);}else sPE(true);}}}
                placeholder="Enter admin password" style={{width:"100%",padding:"10px 12px",fontSize:14,border:"1px solid "+(passErr?"#dc2626":"#d1d5db"),borderRadius:8,boxSizing:"border-box",color:"#1e293b"}}/>
              {passErr&&<p style={{color:"#dc2626",fontSize:11,margin:"4px 0 0"}}>Incorrect password</p>}
            </div>
          )}
          <button onClick={()=>{
            if(!nameIn.trim())return;
            if(ADMIN_NAMES.some(n=>n.toLowerCase()===nameIn.trim().toLowerCase())){
              if(showAP){if(adminPIn===ADMIN_PASS){setAuthToken(nameIn.trim(),"admin",adminPIn);sUN(nameIn.trim());sUR("admin");sPE(false);}else sPE(true);}
              else sSAP(true);
            }else{setAuthToken(nameIn.trim(),"user","");sUN(nameIn.trim());sUR("user");}
          }} style={{marginTop:16,width:"100%",padding:12,background:"#3b82f6",color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontWeight:700,fontSize:14}}>
            Continue ‚Üí
          </button>
          {!showAP&&<p style={{textAlign:"center",marginTop:12,fontSize:11,color:"#94a3b8"}}>Admins: enter your name, you'll be prompted for the password</p>}
        </div>
      </div>
    );
  }

  // ---- UPLOAD / WAITING ----
  if(!loaded&&isAdmin){
    return(
      <div style={{fontFamily:"-apple-system,BlinkMacSystemFont,sans-serif",maxWidth:600,margin:"60px auto",textAlign:"center",padding:"0 16px"}}>
        <div style={{background:"linear-gradient(135deg,#1e293b,#334155)",color:"#fff",padding:24,borderRadius:"12px 12px 0 0"}}>
          <h1 style={{margin:0,fontSize:20}}>Cutover Management App</h1>
          <p style={{margin:"4px 0 0",opacity:0.7,fontSize:12}}>PING Project Evo ‚Ä¢ {uName} (Admin) ‚≠ê</p>
        </div>
        <div style={{padding:40,background:"#fff",border:"1px solid #e2e8f0",borderTop:0,borderRadius:"0 0 12px 12px"}}>
          <div style={{fontSize:48,marginBottom:16}}>üì°</div>
          <h2 style={{fontSize:18,color:"#1e293b",margin:"0 0 8px"}}>Upload Cutover Plan</h2>
          <p style={{color:"#64748b",fontSize:13,margin:"0 0 20px"}}>Upload the CSV to initialize the app for all users.</p>
          <label style={{display:"inline-flex",alignItems:"center",padding:"10px 24px",background:"#3b82f6",color:"#fff",borderRadius:8,cursor:"pointer",fontWeight:600,fontSize:14}}>
            Choose CSV File<input type="file" accept=".csv,.tsv,.txt" onChange={handleFile} style={{display:"none"}}/>
          </label>
          {err&&<p style={{color:"#dc2626",marginTop:12,fontSize:12}}>{err}</p>}
          <div style={{marginTop:16}}><button onClick={()=>{sUN("");sUR("user");}} style={{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:11,textDecoration:"underline"}}>Sign in as different user</button></div>
        </div>
      </div>
    );
  }
  if(!loaded&&!isAdmin){
    return(
      <div style={{fontFamily:"-apple-system,BlinkMacSystemFont,sans-serif",maxWidth:600,margin:"60px auto",textAlign:"center",padding:"0 16px"}}>
        <div style={{background:"linear-gradient(135deg,#1e293b,#334155)",color:"#fff",padding:24,borderRadius:"12px 12px 0 0"}}>
          <h1 style={{margin:0,fontSize:20}}>Cutover Management App</h1>
          <p style={{margin:"4px 0 0",opacity:0.7,fontSize:12}}>PING Project Evo ‚Ä¢ {uName}</p>
        </div>
        <div style={{padding:40,background:"#fff",border:"1px solid #e2e8f0",borderTop:0,borderRadius:"0 0 12px 12px"}}>
          <div style={{fontSize:48,marginBottom:16}}>‚è≥</div>
          <h2 style={{fontSize:18,color:"#1e293b",margin:"0 0 8px"}}>Waiting for Data</h2>
          <p style={{color:"#64748b",fontSize:13,margin:"0 0 20px"}}>An admin needs to upload the CSV first.<br/>Admins: <strong>{ADMIN_NAMES.join(", ")}</strong></p>
          <button onClick={()=>{sUN("");sUR("user");}} style={{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:11,textDecoration:"underline"}}>Sign in as different user</button>
        </div>
      </div>
    );
  }

  // ---- ADD TASK MODAL ----
  function AddModal(){
    return(
      <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:100,display:"flex",alignItems:"center",justifyContent:"center"}}>
        <div style={{background:"#fff",borderRadius:12,padding:24,width:480,maxHeight:"80vh",overflowY:"auto"}}>
          <h3 style={{margin:"0 0 16px",fontSize:16}}>Add New Task</h3>
          {[["id","Task ID*","text"],["d","Description*","textarea"],["s","Status","select",STATUSES.map(s=>({v:s.id,l:s.l}))],["p","Phase","select",PH.map(p=>({v:p.id,l:p.l+" ‚Äî "+p.f}))],["w","Workstream","text"],["a","Application","text"],["r","Responsible","select",[{v:"PING",l:"PING"},{v:"INFOR",l:"INFOR"},{v:"JOINT",l:"JOINT"},{v:"COMBO",l:"COMBO"}]],["ps","PING SME","text"],["ex","Executor","text"],["sd","Start Date","text"],["ed","End Date","text"]].map(([k,lbl,type,opts])=>(
            <div key={k} style={{marginBottom:10}}>
              <label style={{display:"block",fontSize:11,fontWeight:600,color:"#64748b",marginBottom:2}}>{lbl}</label>
              {type==="textarea"?<textarea value={nT[k]} onChange={e=>sNT({...nT,[k]:e.target.value})} rows={2} style={{width:"100%",padding:"6px 8px",fontSize:12,border:"1px solid #d1d5db",borderRadius:6,boxSizing:"border-box",fontFamily:"inherit",color:"#1e293b"}}/>
              :type==="select"?<select value={nT[k]} onChange={e=>sNT({...nT,[k]:e.target.value})} style={{width:"100%",padding:"6px 8px",fontSize:12,border:"1px solid #d1d5db",borderRadius:6,color:"#1e293b"}}>{opts.map(o=>(<option key={o.v} value={o.v}>{o.l}</option>))}</select>
              :<input value={nT[k]} onChange={e=>sNT({...nT,[k]:e.target.value})} style={{width:"100%",padding:"6px 8px",fontSize:12,border:"1px solid #d1d5db",borderRadius:6,boxSizing:"border-box",color:"#1e293b"}}/>}
            </div>
          ))}
          <div style={{display:"flex",gap:8,marginTop:16}}>
            <button onClick={()=>addTask(nT)} style={{flex:1,padding:10,background:"#10b981",color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontWeight:700}}>Add Task</button>
            <button onClick={()=>sAM(false)} style={{flex:1,padding:10,background:"#f1f5f9",color:"#475569",border:"none",borderRadius:8,cursor:"pointer",fontWeight:600}}>Cancel</button>
          </div>
        </div>
      </div>
    );
  }

  // ---- SIDE PANEL ----
  function SPanel(){
    const t=tasks.find(x=>x.id===panel);
    const[noteIn,setNI]=useState("");
    const[depIn,setDI]=useState("");
    const[editMode,setEM]=useState(false);
    if(!t)return null;
    const st=SM[t.s]||SM["1-Planned"];
    const depBlocked=isDepBlocked(t);
    const tIdx=tasks.findIndex(x=>x.id===t.id);
    const nextTask=tasks[tIdx+1];
    return(
      <div style={{width:340,flexShrink:0,background:"#fff",borderLeft:"2px solid #e2e8f0",overflowY:"auto",display:"flex",flexDirection:"column"}}>
        <div style={{background:st.bg,borderBottom:"2px solid "+st.c,padding:"12px 14px",flexShrink:0}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:8}}>
            <div style={{flex:1}}>
              <div style={{fontFamily:"monospace",fontSize:11,fontWeight:700,color:st.c}}>{t.id}</div>
              <div style={{fontSize:12,fontWeight:600,color:"#1e293b",marginTop:2,lineHeight:1.3}}>{t.d.slice(0,80)}{t.d.length>80?"‚Ä¶":""}</div>
            </div>
            <button onClick={()=>sPanel(null)} style={{background:"none",border:"none",color:"#94a3b8",cursor:"pointer",fontSize:18,padding:0,flexShrink:0}}>√ó</button>
          </div>
          <div style={{display:"flex",gap:4,marginTop:8,flexWrap:"wrap"}}>
            {t.ui&&<span style={{fontSize:8,background:"#fef2f2",color:"#dc2626",padding:"2px 5px",borderRadius:3,fontWeight:700}}>US/CA</span>}
            {t.mo&&<span style={{fontSize:8,background:"#fffbeb",color:"#d97706",padding:"2px 5px",borderRadius:3,fontWeight:700}}>MOCK ONLY</span>}
            {t.jp&&<span style={{fontSize:8,background:"#f0fdf4",color:"#16a34a",padding:"2px 5px",borderRadius:3,fontWeight:700}}>JP EXEC</span>}
            {depBlocked&&<span style={{fontSize:8,background:"#fff7ed",color:"#ea580c",padding:"2px 5px",borderRadius:3,fontWeight:700}}>DEP BLOCKED</span>}
          </div>
        </div>
        {/* Status buttons */}
        <div style={{padding:"10px 14px",borderBottom:"1px solid #f1f5f9",flexShrink:0}}>
          <div style={{fontSize:9,fontWeight:700,color:"#94a3b8",marginBottom:5}}>STATUS</div>
          <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
            {STATUSES.map(s=>(
              <button key={s.id} onClick={()=>{updStatus(t.id,s.id);if(s.id==="4-Complete"&&nextTask)sPanel(nextTask.id);}}
                style={{padding:"4px 8px",fontSize:9,fontWeight:700,border:"2px solid "+(t.s===s.id?s.c:"#e2e8f0"),borderRadius:5,cursor:"pointer",background:t.s===s.id?s.bg:"#fff",color:t.s===s.id?s.c:"#64748b"}}>{s.s}</button>
            ))}
          </div>
        </div>
        {t.s==="3-Blocked"&&(
          <div style={{padding:"8px 14px",background:"#fef2f2",borderBottom:"1px solid #fecaca",flexShrink:0}}>
            <div style={{fontSize:9,fontWeight:700,color:"#dc2626",marginBottom:4}}>BLOCKER REASON</div>
            <input value={t.blocker||""} onChange={e=>updField(t.id,"blocker",e.target.value)} placeholder="Describe the blocker‚Ä¶" style={{width:"100%",padding:"5px 8px",fontSize:11,border:"1px solid #fecaca",borderRadius:5,boxSizing:"border-box",color:"#1e293b"}}/>
          </div>
        )}
        {/* Details */}
        <div style={{padding:"10px 14px",borderBottom:"1px solid #f1f5f9",fontSize:11,flexShrink:0}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
            <span style={{fontSize:9,fontWeight:700,color:"#94a3b8"}}>DETAILS</span>
            {isAdmin&&<button onClick={()=>setEM(!editMode)} style={{fontSize:9,padding:"2px 6px",background:editMode?"#3b82f6":"#f1f5f9",color:editMode?"#fff":"#475569",border:"none",borderRadius:4,cursor:"pointer",fontWeight:600}}>{editMode?"Done":"Edit"}</button>}
          </div>
          {!editMode?(
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"3px 10px",fontSize:10,color:"#334155"}}>
              <div><strong>Phase:</strong> {PH.find(p=>p.id===t.p)?.l||t.p}</div>
              <div><strong>Workstream:</strong> {t.w}</div>
              <div><strong>App:</strong> {t.a}</div>
              <div><strong>Responsible:</strong> {t.r}</div>
              <div><strong>PING SME:</strong> {t.ps||"‚Äî"}</div>
              <div><strong>Executor:</strong> {t.ex||"‚Äî"}</div>
              <div><strong>PING Supp:</strong> {t.pp||"‚Äî"}</div>
              <div><strong>Infor SME:</strong> {t.is||"‚Äî"}</div>
              <div><strong>Start:</strong> {t.sdD?fDS(t.sdD):t.sd||"‚Äî"}</div>
              <div><strong>End:</strong> {t.edD?fDS(t.edD):t.ed||"‚Äî"}</div>
            </div>
          ):(
            <div>
              <div style={{marginBottom:6}}>
                <label style={{fontSize:9,fontWeight:600,color:"#94a3b8"}}>Description</label>
                <textarea value={t.d} onChange={e=>updField(t.id,"d",e.target.value)} rows={2} style={{width:"100%",fontSize:11,padding:5,border:"1px solid #d1d5db",borderRadius:4,fontFamily:"inherit",color:"#1e293b",boxSizing:"border-box"}}/>
              </div>
              {[["w","Workstream"],["ex","Executor"],["ps","PING SME"],["pp","PING Supp"],["is","Infor SME"],["sd","Start Date"],["ed","End Date"]].map(([k,lbl])=>(
                <div key={k} style={{marginBottom:4}}>
                  <label style={{fontSize:9,fontWeight:600,color:"#94a3b8"}}>{lbl}</label>
                  <input value={t[k]||""} onChange={e=>updField(t.id,k,e.target.value)} style={{width:"100%",padding:"4px 6px",fontSize:11,border:"1px solid #d1d5db",borderRadius:4,boxSizing:"border-box",color:"#1e293b"}}/>
                </div>
              ))}
              {isAdmin&&<button onClick={()=>delTask(t.id)} style={{marginTop:8,padding:"5px 10px",background:"#fef2f2",color:"#dc2626",border:"1px solid #fecaca",borderRadius:5,cursor:"pointer",fontSize:10,fontWeight:600}}>üóë Delete Task</button>}
            </div>
          )}
        </div>
        {/* Timestamps */}
        {(tsM==="both"||tsM==="est")&&(
          <div style={{padding:"8px 14px",borderBottom:"1px solid #f1f5f9",flexShrink:0}}>
            <div style={{fontSize:9,fontWeight:700,color:"#94a3b8",marginBottom:5}}>ESTIMATED TIMES</div>
            {[["estStart","Est Start"],["estEnd","Est End"]].map(([k,l])=>(
              <div key={k} style={{marginBottom:4,display:"flex",alignItems:"center",gap:6}}>
                <label style={{fontSize:9,color:"#64748b",width:55}}>{l}:</label>
                <input type="time" value={t[k]||""} onChange={e=>updField(t.id,k,e.target.value)} style={{flex:1,padding:"3px 5px",fontSize:10,border:"1px solid #d1d5db",borderRadius:4,color:"#1e293b"}}/>
              </div>
            ))}
          </div>
        )}
        {(tsM==="both"||tsM==="act")&&(
          <div style={{padding:"8px 14px",borderBottom:"1px solid #f1f5f9",flexShrink:0}}>
            <div style={{fontSize:9,fontWeight:700,color:"#94a3b8",marginBottom:5}}>ACTUAL TIMES</div>
            {[["actStart","Act Start"],["actEnd","Act End"]].map(([k,l])=>(
              <div key={k} style={{marginBottom:4,display:"flex",alignItems:"center",gap:6}}>
                <label style={{fontSize:9,color:"#64748b",width:55}}>{l}:</label>
                <input type="time" value={t[k]||""} onChange={e=>updField(t.id,k,e.target.value)} style={{flex:1,padding:"3px 5px",fontSize:10,border:"1px solid #d1d5db",borderRadius:4,color:"#1e293b"}}/>
              </div>
            ))}
          </div>
        )}
        {/* Dependencies */}
        <div style={{padding:"8px 14px",borderBottom:"1px solid #f1f5f9",flexShrink:0}}>
          <div style={{fontSize:9,fontWeight:700,color:"#94a3b8",marginBottom:5}}>DEPENDENCIES</div>
          {(t.deps||[]).map(depId=>{
            const dep=tasks.find(x=>x.id.toUpperCase()===depId.toUpperCase());
            const done=dep&&isDone(dep);
            return(
              <div key={depId} style={{display:"flex",alignItems:"center",gap:4,marginBottom:3}}>
                <span style={{fontSize:9,color:done?"#10b981":"#ea580c",fontWeight:700}}>{done?"‚úì":"‚ö†"}</span>
                <span style={{fontSize:10,fontFamily:"monospace",color:done?"#16a34a":"#ea580c",cursor:"pointer"}} onClick={()=>sPanel(depId)}>{depId}</span>
                {dep&&<span style={{fontSize:9,color:"#64748b"}}>{dep.s.split("-")[1]||dep.s}</span>}
                <button onClick={()=>removeDep(t.id,depId)} style={{marginLeft:"auto",background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:11,padding:0}}>√ó</button>
              </div>
            );
          })}
          <div style={{display:"flex",gap:4,marginTop:4}}>
            <input value={depIn} onChange={e=>setDI(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"){addDep(t.id,depIn);setDI("");}}} placeholder="Task ID‚Ä¶" style={{flex:1,padding:"3px 6px",fontSize:10,border:"1px solid #d1d5db",borderRadius:4,color:"#1e293b"}}/>
            <button onClick={()=>{addDep(t.id,depIn);setDI("");}} style={{padding:"3px 8px",background:"#3b82f6",color:"#fff",border:"none",borderRadius:4,cursor:"pointer",fontSize:10}}>+</button>
          </div>
        </div>
        {/* Notes */}
        <div style={{padding:"8px 14px",borderBottom:"1px solid #f1f5f9",flexShrink:0}}>
          <div style={{fontSize:9,fontWeight:700,color:"#94a3b8",marginBottom:5}}>NOTES</div>
          {(t.notes||[]).map((n,i)=>(
            <div key={i} style={{marginBottom:6,padding:"5px 8px",background:"#f8fafc",borderRadius:5,borderLeft:"3px solid #3b82f6"}}>
              <div style={{fontSize:9,color:"#64748b",marginBottom:2}}>{n.user} ‚Ä¢ {fTS(n.ts,tz)}</div>
              <div style={{fontSize:11,color:"#334155"}}>{n.text}</div>
            </div>
          ))}
          {t.n&&(
            <div style={{marginBottom:6,padding:"5px 8px",background:"#f8fafc",borderRadius:5,borderLeft:"3px solid #94a3b8"}}>
              <div style={{fontSize:9,color:"#94a3b8",marginBottom:2}}>Original (CSV)</div>
              <div style={{fontSize:11,color:"#64748b"}}>{t.n}</div>
            </div>
          )}
          <div style={{display:"flex",gap:4}}>
            <input value={noteIn} onChange={e=>setNI(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"){addNote(t.id,noteIn);setNI("");}}} placeholder="Add note‚Ä¶" style={{flex:1,padding:"5px 8px",fontSize:11,border:"1px solid #d1d5db",borderRadius:5,color:"#1e293b"}}/>
            <button onClick={()=>{addNote(t.id,noteIn);setNI("");}} style={{padding:"5px 10px",background:"#3b82f6",color:"#fff",border:"none",borderRadius:5,cursor:"pointer",fontSize:10,fontWeight:600}}>Add</button>
          </div>
        </div>
        {(t.history||[]).length>0&&(
          <div style={{padding:"8px 14px",flexShrink:0}}>
            <div style={{fontSize:9,fontWeight:700,color:"#94a3b8",marginBottom:5}}>HISTORY</div>
            {(t.history||[]).slice(0,5).map((h,i)=>(
              <div key={i} style={{fontSize:9,color:"#64748b",marginBottom:3}}>{fTS(h.ts,tz)} ‚Äî {h.user}: {SM[h.from]?.l||h.from} ‚Üí {SM[h.to]?.l||h.to}</div>
            ))}
          </div>
        )}
      </div>
    );
  }

  // ---- ROW ----
  function Row({t}){
    const st=SM[t.s]||SM["1-Planned"];
    const pd=isPD(t);const depBlk=isDepBlocked(t);
    const bg=t.id===panel?"#eff6ff":pd?"#fff5f5":depBlk?"#fff7ed":"#fff";
    return(
      <div onClick={()=>sPanel(t.id===panel?null:t.id)} style={{display:"grid",gridTemplateColumns:"70px 44px 1fr 100px 58px 58px",padding:"5px 10px",borderBottom:"1px solid #f1f5f9",cursor:"pointer",background:bg,gap:5,alignItems:"center"}}>
        <div style={{fontFamily:"monospace",fontSize:9,fontWeight:700,color:"#475569",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{t.id}</div>
        <div style={{padding:"2px 4px",background:st.bg,color:st.c,borderRadius:3,fontSize:8,fontWeight:700,textAlign:"center"}}>{st.s}</div>
        <div style={{fontSize:10,color:"#334155",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{t.d}</div>
        <div style={{fontSize:9,color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{t.ex||"‚Äî"}</div>
        <div style={{fontSize:9,color:"#64748b",whiteSpace:"nowrap"}}>{t.sdD?fDS(t.sdD):"‚Äî"}</div>
        <div style={{fontSize:9,color:pd?"#dc2626":"#64748b",whiteSpace:"nowrap",fontWeight:pd?700:400}}>{t.edD?fDS(t.edD):"‚Äî"}</div>
      </div>
    );
  }

  function Sec({label,sub,color,count,done}){
    return(
      <div style={{padding:"6px 10px",background:"#f8fafc",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:8,position:"sticky",top:0,zIndex:2}}>
        <span style={{background:color,color:"#fff",padding:"2px 8px",borderRadius:5,fontSize:11,fontWeight:700}}>{label}</span>
        {sub&&<span style={{fontSize:10,color:"#475569",fontWeight:500}}>{sub}</span>}
        <span style={{marginLeft:"auto",fontSize:10,color:"#64748b"}}>{done}/{count}</span>
        <div style={{width:40,height:4,background:"#e2e8f0",borderRadius:2,overflow:"hidden"}}>
          <div style={{width:`${count?Math.round((done/count)*100):0}%`,height:"100%",background:color,borderRadius:2}}/>
        </div>
      </div>
    );
  }

  // ---- MAIN DASHBOARD ----
  const totDone=tasks.filter(t=>isDone(t)).length;
  const totWip=tasks.filter(t=>t.s==="2-WIP").length;
  const totBlk=tasks.filter(t=>t.s==="3-Blocked").length;
  const pct=tasks.length?Math.round((totDone/tasks.length)*100):0;

  return(
    <div style={{fontFamily:"-apple-system,BlinkMacSystemFont,sans-serif",display:"flex",height:"100vh",overflow:"hidden",color:"#1e293b",fontSize:12}}>
      <div style={{flex:1,overflow:"hidden",display:"flex",flexDirection:"column",minWidth:0}}>
        {/* Header */}
        <div style={{background:"linear-gradient(135deg,#1e293b,#334155)",color:"#fff",padding:"8px 12px",flexShrink:0}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:5}}>
            <div>
              <h1 style={{margin:0,fontSize:14,fontWeight:700}}>Cutover Management App</h1>
              <p style={{margin:0,fontSize:9,opacity:0.6}}>{tasks.length} tasks ‚Ä¢ {uName}{saving?" ‚Ä¢ Saving‚Ä¶":""}{USE_API&&lastSync?" ‚Ä¢ Synced "+Math.round((new Date()-lastSync)/60000)+"m ago":""}</p>
            </div>
            <div style={{display:"flex",gap:3,flexWrap:"wrap"}}>
              {isAdmin&&<button onClick={()=>sAM(true)} style={{padding:"3px 8px",background:"#10b981",borderRadius:4,cursor:"pointer",fontSize:9,fontWeight:700,color:"#fff",border:"none"}}>+ Add</button>}
              {isAdmin&&<label style={{padding:"3px 8px",background:"rgba(255,255,255,0.15)",borderRadius:4,cursor:"pointer",fontSize:9,fontWeight:600,color:"#fff",border:"1px solid rgba(255,255,255,0.2)"}}>Re-upload<input type="file" accept=".csv,.tsv,.txt" onChange={handleFile} style={{display:"none"}}/></label>}
              {isAdmin&&<button onClick={exportCSV} style={{padding:"3px 8px",background:"rgba(255,255,255,0.15)",borderRadius:4,cursor:"pointer",fontSize:9,fontWeight:600,color:"#fff",border:"1px solid rgba(255,255,255,0.2)"}}>Export CSV</button>}
              <button onClick={()=>sSLog(!showLog)} style={{padding:"3px 8px",background:showLog?"rgba(99,179,237,0.3)":"rgba(255,255,255,0.15)",borderRadius:4,cursor:"pointer",fontSize:9,fontWeight:600,color:"#fff",border:"1px solid rgba(255,255,255,0.2)"}}>{showLog?"‚úï Log":"üìù Log"}</button>
              <button onClick={()=>sSH(!showHelp)} style={{padding:"3px 8px",background:showHelp?"rgba(99,179,237,0.3)":"rgba(255,255,255,0.15)",borderRadius:4,cursor:"pointer",fontSize:9,fontWeight:600,color:"#fff",border:"1px solid rgba(255,255,255,0.2)"}}>? Help</button>
              <button onClick={()=>{sUN("");sUR("user");sPanel(null);}} style={{padding:"3px 8px",background:isAdmin?"rgba(251,191,36,0.25)":"rgba(255,255,255,0.15)",borderRadius:4,cursor:"pointer",fontSize:9,fontWeight:600,color:"#fff",border:isAdmin?"1px solid rgba(251,191,36,0.5)":"1px solid rgba(255,255,255,0.2)"}}>{isAdmin?"‚≠ê ":""}{uName}</button>
            </div>
          </div>
          <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",paddingTop:4,borderTop:"1px solid rgba(255,255,255,0.15)"}}>
            {[["TZ",tz,sTz,TZ_L],["TS",tsM,sTsM,TS_M],["VIEW",vM,sVM,VM]].map(([lb,v,fn,opts])=>(
              <div key={lb} style={{display:"flex",gap:2,alignItems:"center"}}>
                <span style={{fontSize:8,opacity:0.5,fontWeight:700}}>{lb}:</span>
                {opts.map(o=>(<button key={o.id} onClick={()=>fn(o.id)} style={{padding:"1px 5px",fontSize:8,fontWeight:600,border:"none",borderRadius:2,cursor:"pointer",background:v===o.id?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.15)",color:v===o.id?"#1e293b":"rgba(255,255,255,0.7)"}}>{o.l}</button>))}
              </div>
            ))}
          </div>
        </div>
        {/* Phase bar */}
        <div style={{display:"flex",gap:2,padding:"4px 8px",background:"#1e293b",flexShrink:0,flexWrap:"wrap"}}>
          <button onClick={()=>sPF("all")} style={{padding:"2px 8px",fontSize:9,fontWeight:700,border:"none",borderRadius:3,cursor:"pointer",background:pF==="all"?"#fff":"rgba(255,255,255,0.15)",color:pF==="all"?"#1e293b":"rgba(255,255,255,0.8)"}}>ALL</button>
          {PH.map(p=>{
            const cnt=tasks.filter(t=>t.p===p.id).length;
            const dn=tasks.filter(t=>t.p===p.id&&isDone(t)).length;
            return(
              <button key={p.id} onClick={()=>sPF(pF===p.id?"all":p.id)} style={{padding:"2px 8px",fontSize:9,fontWeight:700,border:"none",borderRadius:3,cursor:"pointer",display:"flex",alignItems:"center",gap:4,background:pF===p.id?p.cl:"rgba(255,255,255,0.1)",color:pF===p.id?"#fff":"rgba(255,255,255,0.7)"}}>
                <span style={{background:pF===p.id?"rgba(255,255,255,0.25)":p.cl,color:"#fff",borderRadius:2,padding:"0 3px",fontSize:8}}>{p.l}</span>
                <span>{cnt>0?`${dn}/${cnt}`:""}</span>
              </button>
            );
          })}
          {pF!=="all"&&(
            <button onClick={()=>sHD(!hideD)} style={{marginLeft:4,padding:"2px 8px",fontSize:9,fontWeight:700,borderRadius:3,cursor:"pointer",display:"flex",alignItems:"center",gap:3,border:"1px solid "+(hideD?"#10b981":"rgba(255,255,255,0.3)"),background:hideD?"#10b981":"rgba(255,255,255,0.08)",color:hideD?"#fff":"rgba(255,255,255,0.7)"}}>
              {hideD?"‚úì Hiding Done":"Hide Done"}
            </button>
          )}
        </div>
        {/* Progress bar */}
        {tasks.length>0&&(
          <div style={{padding:"3px 8px",background:"#0f172a",flexShrink:0,display:"flex",alignItems:"center",gap:8}}>
            <div style={{flex:1,height:6,background:"#334155",borderRadius:3,overflow:"hidden",display:"flex"}}>
              <div style={{width:`${(totDone/tasks.length)*100}%`,background:"#10b981",height:"100%"}}/>
              <div style={{width:`${(totWip/tasks.length)*100}%`,background:"#f59e0b",height:"100%"}}/>
              <div style={{width:`${(totBlk/tasks.length)*100}%`,background:"#dc2626",height:"100%"}}/>
            </div>
            <span style={{fontSize:9,color:"#94a3b8",whiteSpace:"nowrap"}}>{pct}% complete ‚Ä¢ {totDone}/{tasks.length} done ‚Ä¢ {totWip} WIP ‚Ä¢ {totBlk} blocked</span>
          </div>
        )}
        {/* Help */}
        {showHelp&&(
          <div style={{padding:"8px 10px",background:"#f0f9ff",borderBottom:"2px solid #3b82f6",fontSize:10,lineHeight:1.5,flexShrink:0}}>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"4px 16px"}}>
              <div><strong style={{color:"#3b82f6"}}>Click a task</strong> to open side panel. Change status, add notes, flag blockers.</div>
              <div><strong style={{color:"#f59e0b"}}>Day Focus</strong> ‚Äî pick date + mode for daily execution view.</div>
              <div><strong style={{color:"#10b981"}}>Auto-advance</strong> ‚Äî completing a task opens the next one.</div>
              <div><strong style={{color:"#dc2626"}}>Blocked</strong> ‚Äî set Blocked status, add reason in panel.</div>
              <div><strong style={{color:"#3b82f6"}}>Presets</strong> ‚Äî save your filter combo for quick re-use.</div>
              <div><strong style={{color:"#475569"}}>All changes auto-save.</strong> Export CSV for bulk edits.</div>
            </div>
          </div>
        )}
        {/* Filters */}
        <div style={{padding:"4px 8px",background:"#fff",borderBottom:"1px solid #e2e8f0",display:"flex",gap:4,flexWrap:"wrap",alignItems:"center",flexShrink:0}}>
          <select value={pF} onChange={e=>sPF(e.target.value)} style={{fontSize:10,padding:"2px 4px",border:"1px solid #d1d5db",borderRadius:4,color:"#1e293b"}}>
            <option value="all">All Phases</option>
            {PH.map(p=>(<option key={p.id} value={p.id}>{p.l} ‚Äî {p.f}</option>))}
          </select>
          <select value={wF} onChange={e=>sWF(e.target.value)} style={{fontSize:10,padding:"2px 4px",border:"1px solid #d1d5db",borderRadius:4,color:"#1e293b"}}>
            {ws.map(w=>(<option key={w} value={w}>{w}</option>))}
          </select>
          <select value={sF} onChange={e=>sSF(e.target.value)} style={{fontSize:10,padding:"2px 4px",border:"1px solid #d1d5db",borderRadius:4,color:"#1e293b"}}>
            <option value="all">All Statuses</option>
            {STATUSES.map(s=>(<option key={s.id} value={s.id}>{s.l}</option>))}
          </select>
          <select value={rF} onChange={e=>sRF(e.target.value)} style={{fontSize:10,padding:"2px 4px",border:"1px solid #d1d5db",borderRadius:4,color:"#1e293b"}}>
            {resps.map(r=>(<option key={r} value={r}>{r}</option>))}
          </select>
          <input value={search} onChange={e=>sSrch(e.target.value)} placeholder="Search‚Ä¶" style={{fontSize:10,padding:"2px 6px",border:"1px solid #d1d5db",borderRadius:4,width:120,color:"#1e293b"}}/>
          <label style={{fontSize:9,color:"#475569",display:"flex",alignItems:"center",gap:2}}><input type="checkbox" checked={hideD} onChange={e=>sHD(e.target.checked)}/> Hide Done</label>
          <div style={{position:"relative"}}>
            <button onClick={()=>sSPre(!showPre)} style={{fontSize:9,padding:"2px 6px",background:"#f1f5f9",border:"1px solid #d1d5db",borderRadius:4,cursor:"pointer",color:"#475569"}}>Presets ‚ñæ</button>
            {showPre&&(
              <div style={{position:"absolute",top:"100%",left:0,background:"#fff",border:"1px solid #e2e8f0",borderRadius:6,zIndex:50,minWidth:180,boxShadow:"0 4px 12px rgba(0,0,0,0.1)",padding:8}}>
                {[["My Tasks",()=>{sSrch(uName.split(" ")[0]);sSPre(false);}],["Blocked",()=>{sStFlt(stFlt==="blocked"?null:"blocked");sSPre(false);}],["Past Due",()=>{sStFlt(stFlt==="pastdue"?null:"pastdue");sSPre(false);}],["US/CA Impact",()=>{sStFlt(stFlt==="ui"?null:"ui");sSPre(false);}]].map(([lbl,fn])=>(
                  <button key={lbl} onClick={fn} style={{display:"block",width:"100%",textAlign:"left",padding:"5px 8px",background:"none",border:"none",cursor:"pointer",fontSize:10,color:"#334155",borderRadius:4}}>‚ö° {lbl}</button>
                ))}
                <hr style={{border:"none",borderTop:"1px solid #f1f5f9",margin:"4px 0"}}/>
                {presets.map(p=>(
                  <div key={p.id} style={{display:"flex",gap:4,alignItems:"center"}}>
                    <button onClick={()=>{loadPre(p);sSPre(false);}} style={{flex:1,textAlign:"left",padding:"4px 6px",background:"none",border:"none",cursor:"pointer",fontSize:10,color:"#334155"}}>üìå {p.name}</button>
                    <button onClick={()=>delPre(p.id)} style={{background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:10}}>√ó</button>
                  </div>
                ))}
                <hr style={{border:"none",borderTop:"1px solid #f1f5f9",margin:"4px 0"}}/>
                <div style={{display:"flex",gap:4}}>
                  <input value={preNm} onChange={e=>sPreNm(e.target.value)} placeholder="Preset name‚Ä¶" style={{flex:1,padding:"3px 5px",fontSize:9,border:"1px solid #d1d5db",borderRadius:3,color:"#1e293b"}}/>
                  <button onClick={()=>{savePre();sSPre(false);}} style={{padding:"3px 6px",background:"#3b82f6",color:"#fff",border:"none",borderRadius:3,cursor:"pointer",fontSize:9}}>Save</button>
                </div>
              </div>
            )}
          </div>
        </div>
        {/* Stats */}
        <div style={{display:"grid",gridTemplateColumns:"repeat(8,1fr)",gap:2,padding:"3px 8px",background:"#fff",borderBottom:"1px solid #e2e8f0",flexShrink:0}}>
          {[["Show",stats.total,"#475569",null],["Plan",stats.pln,"#3b82f6","pln"],["WIP",stats.wip,"#f59e0b","wip"],["Done",stats.done,"#10b981","done"],["Blocked",stats.blocked,"#dc2626","blocked"],["Dep",stats.depblk,"#ea580c","depblk"],["Late",stats.pastdue,"#dc2626","pastdue"],["US/CA",stats.ui,"#7c3aed","ui"]].map(([l,v,c,k])=>(
            <div key={l} onClick={()=>{if(k)sStFlt(stFlt===k?null:k);}} style={{textAlign:"center",padding:"2px 1px",cursor:k?"pointer":"default",borderRadius:3,background:stFlt===k?c+"18":"transparent",border:stFlt===k?`1px solid ${c}`:"1px solid transparent"}}>
              <div style={{fontSize:13,fontWeight:700,color:c}}>{v}</div>
              <div style={{fontSize:7,color:stFlt===k?c:"#94a3b8",fontWeight:600}}>{l}{stFlt===k?"‚úï":""}</div>
            </div>
          ))}
        </div>
        {/* Day Focus */}
        <div style={{padding:"4px 8px",background:"#fefce8",borderBottom:"1px solid #fde68a",display:"flex",gap:5,flexWrap:"wrap",alignItems:"center",flexShrink:0}}>
          <span style={{fontSize:9,fontWeight:700,color:"#92400e"}}>DAY FOCUS</span>
          <input type="date" value={focD} onChange={e=>{sFocD(e.target.value);if(dM==="none"&&e.target.value)sDM("starting");}} style={{fontSize:10,padding:"2px 4px",borderRadius:3,border:"1px solid #d97706",color:"#1e293b"}}/>
          <div style={{display:"flex",gap:2}}>
            {[["none","Off"],["starting","Starting"],["dueby","Due EOD"],["goal","Goal ID"]].map(([v,l])=>(
              <button key={v} onClick={()=>sDM(v)} style={{padding:"2px 5px",fontSize:8,fontWeight:600,border:"1px solid #d97706",borderRadius:3,cursor:"pointer",background:dM===v?"#f59e0b":"#fff",color:dM===v?"#fff":"#92400e"}}>{l}</button>
            ))}
          </div>
          {dM==="goal"&&<input value={goalId} onChange={e=>sGI(e.target.value)} placeholder="Task ID" list="tids" style={{fontSize:10,padding:"2px 4px",borderRadius:3,border:"1px solid #d97706",width:80,fontFamily:"monospace",color:"#1e293b"}}/>}
          <datalist id="tids">{tasks.slice(0,500).map(t=>(<option key={t.id} value={t.id}/>))}</datalist>
          {(dM!=="none"||focD)&&<button onClick={()=>{sDM("none");sFocD("");sGI("");}} style={{padding:"1px 4px",fontSize:8,background:"#fee2e2",color:"#dc2626",border:"none",borderRadius:2,cursor:"pointer",fontWeight:700}}>‚úï</button>}
        </div>
        {/* Col headers */}
        <div style={{display:"grid",gridTemplateColumns:"70px 44px 1fr 100px 58px 58px",padding:"3px 10px",background:"#f1f5f9",borderBottom:"1px solid #e2e8f0",fontSize:8,fontWeight:700,color:"#64748b",gap:5,flexShrink:0}}>
          <span>ID</span><span>Status</span><span>Description</span><span>Executor</span><span>Start</span><span>End</span>
        </div>
        {/* Task list */}
        <div style={{flex:1,overflowY:"auto",background:"#fff"}}>
          {vM==="phase"&&PH.filter(p=>pF==="all"||p.id===pF).map(p=>{const pt=phG[p.id]||[];if(!pt.length)return null;const dn=pt.filter(t=>isDone(t)).length;return(<div key={p.id}><Sec label={p.l} sub={p.f} color={p.cl} count={pt.length} done={dn}/>{pt.map(t=>(<Row key={t.id} t={t}/>))}</div>);})}
          {vM==="day"&&dG.map(([day,ts])=>(<div key={day}><Sec label={day} color="#475569" count={ts.length} done={ts.filter(t=>isDone(t)).length}/>{ts.map(t=>(<Row key={t.id} t={t}/>))}</div>))}
          {vM==="flat"&&sf.map(t=>(<Row key={t.id} t={t}/>))}
          {!sf.length&&<div style={{padding:30,textAlign:"center",color:"#94a3b8",fontSize:12}}>No tasks match current filters</div>}
        </div>
      </div>
      {panel&&!showLog&&<SPanel/>}
      {showLog&&(
        <div style={{width:340,flexShrink:0,background:"#fff",borderLeft:"2px solid #e2e8f0",overflowY:"auto",display:"flex",flexDirection:"column"}}>
          <div style={{padding:"10px 14px",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
            <h3 style={{margin:0,fontSize:13,fontWeight:700}}>Activity Log</h3>
            <button onClick={()=>sSLog(false)} style={{background:"none",border:"none",cursor:"pointer",color:"#94a3b8",fontSize:16}}>√ó</button>
          </div>
          <div style={{flex:1,overflowY:"auto",padding:8}}>
            {actLog.map(e=>(
              <div key={e.id} style={{marginBottom:6,padding:"5px 8px",background:"#f8fafc",borderRadius:5,borderLeft:"3px solid #3b82f6"}}>
                <div style={{fontSize:9,color:"#64748b",marginBottom:1}}>{e.user} ‚Ä¢ {fTS(e.ts,tz)}</div>
                <div style={{fontSize:10,color:"#334155"}}>{e.msg}</div>
              </div>
            ))}
            {!actLog.length&&<div style={{padding:20,textAlign:"center",color:"#94a3b8",fontSize:11}}>No activity yet</div>}
          </div>
        </div>
      )}
      {addM&&<AddModal/>}
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById("root"));
</script>
</body>
</html>
